name: agri-news-brief

on:
  schedule:
    - cron: "0 22 * * *"   # 07:00 KST
  workflow_dispatch:
    inputs:
      force_report_date:
        description: "재생성할 리포트 날짜 (YYYY-MM-DD, KST 기준). 비우면 자동 날짜(정상 실행)."
        required: false
        default: ""

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run main
        env:
          # GitHub API 업로드/상태저장에 필요
          GITHUB_TOKEN: ${{ github.token }}

          # OpenAI
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-5.2
          OPENAI_REASONING_EFFORT: minimal
          OPENAI_MAX_OUTPUT_TOKENS: "1200"

          # Kakao
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          KAKAO_REFRESH_TOKEN: ${{ secrets.KAKAO_REFRESH_TOKEN }}

          # Naver
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          NAVER_MAX_WORKERS: "1"
          NAVER_MIN_INTERVAL_SEC: "0.6"

          # 운영 모드 (핵심)
          KAKAO_SEND_MODE: single_text      # ✅ 카톡 1메시지
          PUBLISH_MODE: github_pages        # ✅ gist 대신 Pages로 보기
          PAGES_BRANCH: main
          PAGES_FILE_PATH: docs/index.html  # ✅ Pages 루트로 바로 열림
          BRIEF_VIEW_URL: ${{ vars.BRIEF_VIEW_URL }}

          # 상태 저장(권장: repo에 저장해서 gist 제거)
          STATE_BACKEND: repo
          STATE_FILE_PATH: .agri_state.json

          # 수집량 튜닝
          MAX_ARTICLES_PER_SECTION: "7"
          MIN_ARTICLES_PER_SECTION: "3"
          GLOBAL_BACKFILL_LIMIT: "160"
          MAX_PAGES_PER_QUERY: "4"
          RUN_HOUR_KST: "7"

          # ✅ (방법 B) 특정 날짜 재생성용: Actions UI 입력값 → env 연결
          # - schedule 실행에서는 inputs가 없으므로 기본값 '' 처리
          FORCE_REPORT_DATE: ${{ github.event.inputs.force_report_date || '' }}

          # 테스트할 때만 1로(주말/공휴일 스킵 무시)
          FORCE_RUN_ANYDAY: "true"
          FORCE_SEND: "0"

        run: python main.py
