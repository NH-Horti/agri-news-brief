name: agri-news-brief

on:
  schedule:
    - cron: "0 22 * * *"   # 07:00 KST
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run main
        env:
          # GitHub API 업로드/상태저장에 필요
          GITHUB_TOKEN: ${{ github.token }}

          # OpenAI
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-5.2
          OPENAI_REASONING_EFFORT: minimal
          OPENAI_MAX_OUTPUT_TOKENS: "1200"

          # Kakao
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          KAKAO_REFRESH_TOKEN: ${{ secrets.KAKAO_REFRESH_TOKEN }}

          # 운영 모드 (핵심)
          KAKAO_SEND_MODE: single_text      # ✅ 카톡 1메시지
          PUBLISH_MODE: github_pages        # ✅ gist 대신 Pages로 보기
          PAGES_BRANCH: main
          PAGES_FILE_PATH: docs/index.html  # ✅ Pages 루트로 바로 열림
          BRIEF_VIEW_URL: ${{ vars.BRIEF_VIEW_URL }}

          # 상태 저장(권장: repo에 저장해서 gist 제거)
          STATE_BACKEND: repo
          STATE_FILE_PATH: .agri_state.json

          # 수집량 튜닝
          MAX_ARTICLES_PER_SECTION: "3"

          # 테스트할 때만 1로(주말/공휴일 스킵 무시)
          FORCE_SEND: "1"

        run: python main.py
