name: agri-news-brief

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

on:
  schedule:
    - cron: "0 22 * * *"   # 07:00 KST
  workflow_dispatch:
    inputs:
      ux_patch_days:
        description: "최근 N일 아카이브에 UI/UX 패치 적용 (스와이프/스티키/로딩). 0이면 OFF"
        required: false
        default: "30"
      force_report_date:
        description: "보고서 날짜(YYYY-MM-DD). 비우면 자동(07:00 컷오프 기준)"
        required: false
        default: ""
      backfill_days:
        description: "최근 N일 아카이브 재빌드(필터/스코어 반영). 0이면 OFF"
        required: false
        default: "0"
      backfill_skip_openai:
        description: "백필 재빌드시 OpenAI 요약 생략(true/false)"
        required: false
        default: "true"
      backfill_sleep_sec:
        description: "백필 날짜 간 sleep(초). 레이트리밋 완화용"
        required: false
        default: "0.2"

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # ✅ 태그/히스토리 포함(빌드태그 자동화를 위해 필요)

      - name: Compute BUILD_TAG
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force

          # ✅ v숫자 태그(v42, v43, ...)가 있으면 그것을 기준으로 자동 BUILD_TAG 생성
          #    - 태그 커밋이면: v42
          #    - 태그 이후 커밋이면: v42-3-g1a2b3c4
          # ✅ 태그가 하나도 없으면: v0-<run_number>-<sha7>
          LATEST_TAG="$(git tag --list 'v[0-9]*' --sort=-v:refname | head -n 1 || true)"

          if [ -n "${LATEST_TAG}" ]; then
            BUILD_TAG="$(git describe --tags --match 'v[0-9]*' --always --abbrev=7)"
          else
            SHA7="${GITHUB_SHA::7}"
            BUILD_TAG="v0-${GITHUB_RUN_NUMBER}-${SHA7}"
          fi

          echo "BUILD_TAG=$BUILD_TAG" >> "$GITHUB_ENV"
          echo "BUILD_TAG=$BUILD_TAG"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run main
        env:
          # ✅ 완전 자동 빌드태그
          BUILD_TAG: ${{ env.BUILD_TAG }}

          # GitHub API 업로드/상태저장에 필요
          GITHUB_TOKEN: ${{ github.token }}

          # OpenAI
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-5.2
          OPENAI_REASONING_EFFORT: low
          OPENAI_MAX_OUTPUT_TOKENS: "1200"
          OPENAI_BATCH_SIZE: "25"  # ✅ 요약 배치 분할
          OPENAI_RETRY_MAX: "3"
          OPENAI_SUMMARY_CACHE_MAX: "2000"  # ✅ 요약 캐시(키 개수)

          # Kakao
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          KAKAO_REFRESH_TOKEN: ${{ secrets.KAKAO_REFRESH_TOKEN }}
          KAKAO_FAIL_OPEN: "true"  # ✅ 카카오 실패해도 페이지 발행 성공 처리
          KAKAO_RETRY_MAX: "3"

          # Naver
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          NAVER_MAX_WORKERS: "1"
          NAVER_MIN_INTERVAL_SEC: "0.6"

          # 운영 모드 (핵심)
          KAKAO_SEND_MODE: single_text      # ✅ 카톡 1메시지
          PUBLISH_MODE: github_pages        # ✅ gist 대신 Pages로 보기
          PAGES_BRANCH: main
          PAGES_FILE_PATH: docs/index.html  # ✅ Pages 루트로 바로 열림
          BRIEF_VIEW_URL: ${{ vars.BRIEF_VIEW_URL }}
          # 상태 저장(권장: repo에 저장해서 gist 제거)
          STATE_FILE_PATH: .agri_state.json
          GH_PUT_MAX_RETRIES: "4"

          # 수집량 튜닝
          MAX_ARTICLES_PER_SECTION: "5"
          MIN_ARTICLES_PER_SECTION: "3"
          GLOBAL_BACKFILL_LIMIT: "160"
          MAX_PAGES_PER_QUERY: "4"
          RUN_HOUR_KST: "7"

          # ✅ 특정 날짜/백필/UX 패치: Actions UI 입력값 → env 연결 (스케줄 실행에도 안전)
          FORCE_REPORT_DATE: "${{ github.event.inputs.force_report_date || '' }}"
          FORCE_END_NOW: "false"

          # UX patch (기존 아카이브 UI/UX 패치)
          UX_PATCH_DAYS: "${{ github.event.inputs.ux_patch_days || '30' }}"

          # Backfill rebuild (최근 N일 아카이브 재생성)
          BACKFILL_REBUILD_DAYS: "${{ github.event.inputs.backfill_days || '0' }}"
          BACKFILL_REBUILD_SKIP_OPENAI: "${{ github.event.inputs.backfill_skip_openai || 'true' }}"
          BACKFILL_REBUILD_SLEEP_SEC: "${{ github.event.inputs.backfill_sleep_sec || '0.2' }}"

          # 테스트할 때만 1로(주말/공휴일 스킵 무시)
          FORCE_RUN_ANYDAY: "false"
          FORCE_SEND: "0"

        run: python main.py
