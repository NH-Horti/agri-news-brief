name: agri-news-brief (daily)

concurrency:
  group: agri-news-brief-${{ github.ref }}
  cancel-in-progress: false

on:
  schedule:
    # 07:00 KST on business days (Mon-Fri KST) == 22:00 UTC on Sun-Thu
    - cron: "0 22 * * 0-4"
  workflow_dispatch:
    inputs:
      force_report_date:
        description: "특정 날짜(YYYY-MM-DD) 브리핑 재생성. 비우면 자동(07:00 컷오프 기준)"
        required: false
        default: ""
      allow_weekend:
        description: "주말/공휴일에도 실행 허용(true/false). 기본 false"
        required: false
        default: "false"

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run main.py
        env:
          # GitHub
          GITHUB_TOKEN: ${{ github.token }}

          # Naver
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          NAVER_MAX_WORKERS: "1"
          NAVER_MIN_INTERVAL_SEC: "0.6"

          # OpenAI
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: "gpt-5.2"
          OPENAI_REASONING_EFFORT: "low"
          OPENAI_MAX_OUTPUT_TOKENS: "1200"
          OPENAI_BATCH_SIZE: "25"
          OPENAI_RETRY_MAX: "3"
          OPENAI_SUMMARY_CACHE_MAX: "2000"

          # Kakao
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          KAKAO_REFRESH_TOKEN: ${{ secrets.KAKAO_REFRESH_TOKEN }}
          KAKAO_FAIL_OPEN: "true"

          # 운영 모드
          KAKAO_SEND_MODE: "single_text"
          PUBLISH_MODE: "github_pages"
          PAGES_BRANCH: "main"
          PAGES_FILE_PATH: "docs/index.html"
          BRIEF_VIEW_URL: ${{ vars.BRIEF_VIEW_URL }}
          STATE_FILE_PATH: ".agri_state.json"
          GH_PUT_MAX_RETRIES: "4"

          # 수집량 튜닝
          MAX_ARTICLES_PER_SECTION: "5"
          MIN_ARTICLES_PER_SECTION: "3"
          GLOBAL_BACKFILL_LIMIT: "160"
          MAX_PAGES_PER_QUERY: "4"
          RUN_HOUR_KST: "7"
          WINDOW_MIN_HOURS: "72"
          CROSSDAY_DEDUPE_DAYS: "7"
          CROSSDAY_DEDUPE_ENABLED: "true"

          # 수동 재생성
          FORCE_REPORT_DATE: "${{ github.event.inputs.force_report_date || '' }}"
          FORCE_RUN_ANYDAY: "${{ github.event.inputs.allow_weekend || 'false' }}"
          FORCE_END_NOW: "false"

          # 최근 생성/패치 누락된 과거 페이지에 UI/UX가 확산되도록 daily에서도 소규모 UX 패치 수행
          UX_PATCH_DAYS: "45"
          BACKFILL_REBUILD_DAYS: "0"
          BACKFILL_REBUILD_SKIP_OPENAI: "false"
        run: python main.py

- name: Sync workspace to origin/main (after API writes)
  if: ${{ always() }}
  run: |
    git fetch origin main
    git reset --hard origin/main

- name: Pack artifact (docs + state)
  if: ${{ always() }}
  run: |
    tar --ignore-failed-read -czf agri-news-brief_artifact.tgz docs .agri_state.json .agri_archive.json .agri_summary_cache.json || true
    ls -lh agri-news-brief_artifact.tgz || true

- name: Upload artifact
  if: ${{ always() }}
  uses: actions/upload-artifact@v4
  with:
    name: agri-news-brief-${{ github.run_id }}
    path: agri-news-brief_artifact.tgz
    retention-days: 30
